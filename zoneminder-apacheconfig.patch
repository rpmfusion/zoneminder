From c294e25dbc327834e93f5efb26cdf719f194fa20 Mon Sep 17 00:00:00 2001
From: Andrew Bauer <zonexpertconsulting@outlook.com>
Date: Fri, 14 Jul 2017 07:23:35 -0500
Subject: [PATCH] rpm packaging - migrate cakephp htaccess parms into main
 apache config

---
 distros/redhat/systemd/zoneminder.conf.in  | 29 ++++++++++++++-
 distros/redhat/sysvinit/zoneminder.conf.in | 59 ++++++++++++++++++++++++++----
 2 files changed, 78 insertions(+), 10 deletions(-)

diff --git a/distros/redhat/systemd/zoneminder.conf.in b/distros/redhat/systemd/zoneminder.conf.in
index 005c959a6..0e546f9df 100644
--- a/distros/redhat/systemd/zoneminder.conf.in
+++ b/distros/redhat/systemd/zoneminder.conf.in
@@ -16,7 +16,7 @@ Alias /zm "@ZM_WEBDIR@"
     DirectoryIndex index.php
     SSLRequireSSL
     Options -Indexes +MultiViews +FollowSymLinks
-    AllowOverride All
+    AllowOverride None
     <IfModule mod_authz_core.c>
        # Apache 2.4
        Require all granted
@@ -31,7 +31,7 @@ Alias /zm "@ZM_WEBDIR@"
 ScriptAlias /cgi-bin-zm "@ZM_CGIDIR@"
 <Directory "@ZM_CGIDIR@">
     SSLRequireSSL
-    AllowOverride All
+    AllowOverride None
     Options +ExecCGI +FollowSymLinks
     <IfModule mod_authz_core.c>
        # Apache 2.4
@@ -44,3 +44,28 @@ ScriptAlias /cgi-bin-zm "@ZM_CGIDIR@"
     </IfModule>
 </Directory>
 
+# For better visibility, the following directives have been migrated from the
+# default .htaccess files included with the CakePHP project.
+# Parameters not set here are inherited from the parent directive above.
+<Directory "@ZM_WEBDIR@/api">
+   RewriteEngine on
+   RewriteRule ^$ app/webroot/ [L]
+   RewriteRule (.*) app/webroot/$1 [L]
+   RewriteBase /zm/api
+</Directory>
+
+<Directory "@ZM_WEBDIR@/api/app">
+   RewriteEngine on
+   RewriteRule ^$ webroot/ [L]
+   RewriteRule (.*) webroot/$1 [L]
+   RewriteBase /zm/api
+</Directory>
+
+<Directory "@ZM_WEBDIR@/api/app/webroot">
+    RewriteEngine On
+    RewriteCond %{REQUEST_FILENAME} !-d
+    RewriteCond %{REQUEST_FILENAME} !-f
+    RewriteRule ^ index.php [L]
+    RewriteBase /zm/api
+</Directory>
+
diff --git a/distros/redhat/sysvinit/zoneminder.conf.in b/distros/redhat/sysvinit/zoneminder.conf.in
index 413910214..0e546f9df 100644
--- a/distros/redhat/sysvinit/zoneminder.conf.in
+++ b/distros/redhat/sysvinit/zoneminder.conf.in
@@ -11,18 +11,61 @@ RewriteRule ^/?(zm)(.*) https://%{SERVER_NAME}/$1$2 [R,L]
 
 Alias /zm "@ZM_WEBDIR@"
 <Directory "@ZM_WEBDIR@">
+    # explicitly set index.php as the only directoryindex
+    DirectoryIndex disabled
+    DirectoryIndex index.php
     SSLRequireSSL
-    Options -Indexes MultiViews FollowSymLinks
-    AllowOverride All
-    Order allow,deny
-    Allow from all
+    Options -Indexes +MultiViews +FollowSymLinks
+    AllowOverride None
+    <IfModule mod_authz_core.c>
+       # Apache 2.4
+       Require all granted
+    </IfModule>
+    <IfModule !mod_authz_core.c>
+        # Apache 2.2
+        Order deny,allow
+        Allow from all
+    </IfModule>
 </Directory>
 
 ScriptAlias /cgi-bin/zm "@ZM_CGIDIR@"
 <Directory "@ZM_CGIDIR@">
     SSLRequireSSL
-    AllowOverride All
-    Options ExecCGI FollowSymLinks
-    Order allow,deny
-    Allow from all
+    AllowOverride None
+    Options +ExecCGI +FollowSymLinks
+    <IfModule mod_authz_core.c>
+       # Apache 2.4
+       Require all granted
+    </IfModule>
+    <IfModule !mod_authz_core.c>
+        # Apache 2.2
+        Order deny,allow
+        Allow from all
+    </IfModule>
 </Directory>
+
+# For better visibility, the following directives have been migrated from the
+# default .htaccess files included with the CakePHP project.
+# Parameters not set here are inherited from the parent directive above.
+<Directory "@ZM_WEBDIR@/api">
+   RewriteEngine on
+   RewriteRule ^$ app/webroot/ [L]
+   RewriteRule (.*) app/webroot/$1 [L]
+   RewriteBase /zm/api
+</Directory>
+
+<Directory "@ZM_WEBDIR@/api/app">
+   RewriteEngine on
+   RewriteRule ^$ webroot/ [L]
+   RewriteRule (.*) webroot/$1 [L]
+   RewriteBase /zm/api
+</Directory>
+
+<Directory "@ZM_WEBDIR@/api/app/webroot">
+    RewriteEngine On
+    RewriteCond %{REQUEST_FILENAME} !-d
+    RewriteCond %{REQUEST_FILENAME} !-f
+    RewriteRule ^ index.php [L]
+    RewriteBase /zm/api
+</Directory>
+

